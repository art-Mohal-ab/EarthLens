# EarthLens Deployment Guide

This guide covers deploying the EarthLens application with the backend on Render and frontend on Vercel.

## Prerequisites

- GitHub account with your EarthLens repository
- Render account (https://render.com)
- Vercel account (https://vercel.com)
- Groq API key (https://console.groq.com)
- PostgreSQL database (provided by Render)

---

## Backend Deployment (Render)

### 1. Prepare Database Connection

You already have your PostgreSQL database credentials:
```
Host: dpg-d41dii75r7bs739d32gg-a.oregon-postgres.render.com
Database: earthlens
User: earthlens_user
Password: WXXEok6HdaeluZdzOpOrGKmenCTUK3Uw
```

Connection string format:
```
postgresql://earthlens_user:WXXEok6HdaeluZdzOpOrGKmenCTUK3Uw@dpg-d41dii75r7bs739d32gg-a.oregon-postgres.render.com/earthlens
```

### 2. Deploy Backend to Render

#### Option A: Using render.yaml (Recommended)

1. Push your code to GitHub
2. Go to Render Dashboard
3. Click "New" → "Blueprint"
4. Connect your GitHub repository
5. Render will automatically detect `server/render.yaml`
6. Set the following environment variables in Render dashboard:
   - `GROQ_API_KEY`: Your Groq API key
   - `FRONTEND_URL`: Your Vercel frontend URL (update after frontend deployment)

#### Option B: Manual Setup

1. Go to Render Dashboard
2. Click "New" → "Web Service"
3. Connect your GitHub repository
4. Configure:
   - **Name**: earthlens-api
   - **Region**: Oregon (US West)
   - **Branch**: main
   - **Root Directory**: server
   - **Runtime**: Python 3
   - **Build Command**: `pip install -r requirements.txt`
   - **Start Command**: `gunicorn --bind 0.0.0.0:$PORT run:app`

5. Add Environment Variables:
   ```
   FLASK_ENV=production
   SECRET_KEY=<auto-generate>
   JWT_SECRET_KEY=<auto-generate>
   DATABASE_URL=postgresql://earthlens_user:WXXEok6HdaeluZdzOpOrGKmenCTUK3Uw@dpg-d41dii75r7bs739d32gg-a.oregon-postgres.render.com/earthlens
   GROQ_API_KEY=<your-groq-api-key>
   GROQ_MODEL=llama-3.1-70b-versatile
   GROQ_TEMPERATURE=0.7
   GROQ_MAX_TOKENS=500
   FRONTEND_URL=<your-vercel-url>
   ```

6. Click "Create Web Service"

### 3. Initialize Database

After deployment, run database migrations:

```bash
# SSH into your Render service or use Render Shell
flask db upgrade
python seed.py  # Optional: seed initial data
```

### 4. Verify Backend

Visit: `https://your-app.onrender.com/api/health`

You should see:
```json
{
  "status": "healthy",
  "message": "EarthLens API is running",
  "version": "1.0.0",
  "environment": "production"
}
```

---

## Frontend Deployment (Vercel)

### 1. Prepare Frontend

Create a `.env.production` file in the `Client` directory:

```env
VITE_API_URL=https://your-backend-url.onrender.com/api
```

### 2. Deploy to Vercel

#### Option A: Using Vercel CLI

```bash
cd Client
npm install -g vercel
vercel login
vercel --prod
```

#### Option B: Using Vercel Dashboard

1. Go to Vercel Dashboard (https://vercel.com)
2. Click "Add New" → "Project"
3. Import your GitHub repository
4. Configure:
   - **Framework Preset**: Vite
   - **Root Directory**: Client
   - **Build Command**: `npm run build`
   - **Output Directory**: dist
   - **Install Command**: `npm install`

5. Add Environment Variables:
   ```
   VITE_API_URL=https://your-backend-url.onrender.com/api
   ```

6. Click "Deploy"

### 3. Update Backend CORS

After getting your Vercel URL, update the backend:

1. Go to Render Dashboard
2. Open your web service
3. Update `FRONTEND_URL` environment variable:
   ```
   FRONTEND_URL=https://your-app.vercel.app
   ```
4. Save and redeploy

---

## Post-Deployment Configuration

### 1. Update CORS Origins

The backend is configured to accept requests from the `FRONTEND_URL` environment variable. Ensure it matches your Vercel deployment URL.

### 2. Test CORS

Open browser console on your frontend and check for CORS errors. You should see:
- `Access-Control-Allow-Origin` header in responses
- No CORS-related errors

### 3. Verify API Connection

Test the connection:
```javascript
// In browser console on your frontend
fetch('https://your-backend.onrender.com/api/health')
  .then(r => r.json())
  .then(console.log)
```

---

## Environment Variables Summary

### Backend (Render)
```env
FLASK_ENV=production
SECRET_KEY=<auto-generated>
JWT_SECRET_KEY=<auto-generated>
DATABASE_URL=postgresql://earthlens_user:WXXEok6HdaeluZdzOpOrGKmenCTUK3Uw@dpg-d41dii75r7bs739d32gg-a.oregon-postgres.render.com/earthlens
GROQ_API_KEY=<your-groq-api-key>
GROQ_MODEL=llama-3.1-70b-versatile
GROQ_TEMPERATURE=0.7
GROQ_MAX_TOKENS=500
FRONTEND_URL=https://your-app.vercel.app
```

### Frontend (Vercel)
```env
VITE_API_URL=https://your-backend.onrender.com/api
```

---

## Troubleshooting

### CORS Issues

**Problem**: CORS errors in browser console

**Solution**:
1. Verify `FRONTEND_URL` in backend matches your Vercel URL exactly
2. Check that backend CORS configuration includes your frontend URL
3. Ensure `withCredentials: true` is set in axios config

### Database Connection Issues

**Problem**: Backend can't connect to database

**Solution**:
1. Verify `DATABASE_URL` format is correct
2. Check database is running in Render dashboard
3. Ensure IP whitelist allows Render's IPs (usually automatic)

### API Not Responding

**Problem**: 502/503 errors from backend

**Solution**:
1. Check Render logs for errors
2. Verify `gunicorn` is starting correctly
3. Check health endpoint: `/api/health`
4. Ensure all required environment variables are set

### Build Failures

**Frontend Build Issues**:
```bash
# Clear cache and rebuild
rm -rf node_modules package-lock.json
npm install
npm run build
```

**Backend Build Issues**:
```bash
# Check requirements.txt for version conflicts
pip install -r requirements.txt --no-cache-dir
```

---

## Monitoring & Maintenance

### Logs

- **Backend**: View in Render Dashboard → Your Service → Logs
- **Frontend**: View in Vercel Dashboard → Your Project → Deployments → Logs

### Database Backups

Render provides automatic backups for paid plans. For free tier:
```bash
# Manual backup
pg_dump -h dpg-d41dii75r7bs739d32gg-a.oregon-postgres.render.com -U earthlens_user earthlens > backup.sql
```

### Updating Deployments

- **Backend**: Push to GitHub main branch (auto-deploys)
- **Frontend**: Push to GitHub main branch (auto-deploys)

---

## Security Checklist

- ✅ Use environment variables for all secrets
- ✅ Enable HTTPS (automatic on Render/Vercel)
- ✅ Configure CORS with specific origins (not wildcard)
- ✅ Use strong SECRET_KEY and JWT_SECRET_KEY
- ✅ Keep dependencies updated
- ✅ Enable rate limiting (consider adding to backend)
- ✅ Validate all user inputs
- ✅ Use prepared statements for database queries (SQLAlchemy does this)

---

## Performance Optimization

### Backend
- Use Gunicorn with multiple workers
- Enable database connection pooling
- Add caching for frequently accessed data
- Monitor Groq API usage and rate limits

### Frontend
- Enable Vercel's Edge Network (automatic)
- Optimize images and assets
- Use code splitting
- Enable compression

---

## Cost Estimates

### Free Tier
- **Render**: Free tier includes 750 hours/month
- **Vercel**: Free tier includes unlimited deployments
- **PostgreSQL**: Free tier on Render (limited storage)
- **Groq API**: Check current pricing at console.groq.com

### Scaling
When you need to scale:
- Upgrade Render plan for more resources
- Upgrade database for more storage/connections
- Consider CDN for static assets
- Monitor Groq API costs

---

## Support

- **Render Docs**: https://render.com/docs
- **Vercel Docs**: https://vercel.com/docs
- **Groq Docs**: https://console.groq.com/docs
- **Flask Docs**: https://flask.palletsprojects.com/

---

## Quick Deploy Commands

```bash
# Backend - Initialize database
flask db upgrade
python seed.py

# Frontend - Build and deploy
cd Client
npm install
npm run build
vercel --prod

# Test deployment
curl https://your-backend.onrender.com/api/health
```

---

**Note**: Replace all placeholder URLs (`your-app.vercel.app`, `your-backend.onrender.com`) with your actual deployment URLs.
